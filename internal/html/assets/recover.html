<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'nonce-{{CSP_NONCE}}' 'wasm-unsafe-eval'; style-src 'unsafe-inline'; img-src blob: data:; connect-src blob:; form-action 'none';">
  <title>ReMemory Recovery Tool</title>
  <style>{{STYLES}}</style>
</head>
<body>
  <!-- Toast notifications container -->
  <div id="toast-container" class="toast-container" role="alert" aria-live="polite"></div>

  <!-- QR Scanner modal -->
  <div id="qr-scanner-modal" class="qr-scanner-modal hidden">
    <div class="qr-scanner-header">
      <span data-i18n="scan_title">Scan a QR code</span>
      <button id="qr-scanner-close" class="qr-scanner-close">&times;</button>
    </div>
    <div class="qr-scanner-body">
      <video id="qr-video" autoplay playsinline></video>
      <div class="qr-scanner-overlay"></div>
    </div>
    <div class="qr-scanner-hint">
      <span data-i18n="scan_hint">Point your camera at a QR code from a friend's PDF</span>
    </div>
  </div>

  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; color: var(--text-secondary);" data-i18n="loading">Loading...</p>
  </div>

  <div class="container">
    <nav class="site-nav">
      <a href="index.html" class="logo">ðŸ§  ReMemory</a>
      <div class="nav-links" id="nav-links-standalone">
        <a href="index.html">About</a>
        <a href="maker.html">Create Bundles</a>
        <a href="docs.html#recovering">Guide</a>
        <a href="https://github.com/eljojo/rememory" target="_blank">GitHub</a>
      </div>
      <div class="nav-links hidden" id="nav-links-bundle">
        <a href="https://eljojo.github.io/rememory/docs#recovering" target="_blank">Guide</a>
      </div>
      <div class="lang-toggle">
        <button data-lang="en" class="active">EN</button>
        <button data-lang="es">ES</button>
        <button data-lang="de">DE</button>
        <button data-lang="fr">FR</button>
        <button data-lang="sl">SL</button>
      </div>
    </nav>

    <div class="page-intro">
      <h1 data-i18n="title">Recover Files</h1>
      <p class="subtitle" data-i18n="subtitle">Bring together the pieces your friends kept safe.</p>
      <p class="summary" data-i18n="page_description">Each friend received a bundle with one piece of the key. Gather enough pieces below, add the encrypted archive, and your files will be decrypted here in the browser. Nothing leaves your device.</p>
    </div>

    <!-- Step 1: Collect Shares -->
    <div class="card">
      <h2><span class="step-number">1</span> <span data-i18n="step1_title">Gather the pieces</span></h2>
      <div id="share-drop-zone" class="drop-zone">
        <p data-i18n="step1_drop">Drop README.txt files here, or click to choose them</p>
        <small data-i18n="step1_hint">Each file holds one person's piece</small>
      </div>
      <input type="file" id="share-file-input" accept=".txt,.zip" multiple>

      <div class="paste-section">
        <button id="paste-toggle-btn" class="btn btn-secondary" type="button">
          <span>ðŸ“‹</span> <span data-i18n="paste_btn">Paste a piece or type recovery words</span>
        </button>
        <button id="scan-qr-btn" class="btn btn-secondary hidden" type="button">
          <span>ðŸ“·</span> <span data-i18n="scan_btn">Scan QR code</span>
        </button>
        <div id="paste-area" class="paste-area hidden">
          <textarea id="paste-input" placeholder="Paste share text or type your 25 recovery words here..." data-i18n-placeholder="paste_placeholder" rows="6"></textarea>
          <button id="paste-submit-btn" class="btn btn-primary" type="button" data-i18n="paste_submit">Add piece</button>
        </div>
      </div>

      <div id="shares-list" class="shares-list"></div>

      <!-- Contact list for other friends (populated via JS if personalization data exists) -->
      <div id="contact-list-section" class="contact-list-section hidden">
        <h3 data-i18n="contact_list">Contact the others</h3>
        <p class="hint" data-i18n="contact_list_hint">Reach out to these friends to gather their pieces</p>
        <div id="contact-list" class="contact-list"></div>
      </div>

      <div id="threshold-info" class="threshold-info hidden"></div>
    </div>

    <!-- Step 2: Load Manifest -->
    <div class="card">
      <h2><span class="step-number">2</span> <span data-i18n="step2_title">Add the encrypted archive</span></h2>
      <div id="manifest-drop-zone" class="drop-zone">
        <p data-i18n="step2_drop">Drop a recover.html or MANIFEST.age here, or click to choose it</p>
        <small data-i18n="step2_hint">Use a recover.html from any friend's bundle, or the MANIFEST.age file</small>
      </div>
      <input type="file" id="manifest-file-input" accept=".age,.html,.htm,.zip">

      <div id="manifest-status" class="manifest-status hidden">
        <span class="icon">&#128196;</span>
        <div data-i18n="no_manifest">No archive added yet</div>
      </div>
    </div>

    <!-- Step 3: Recover -->
    <div class="card">
      <h2><span class="step-number">3</span> <span data-i18n="step3_title">Recover the files</span></h2>
      <div id="recover-section" class="recover-section">
        <button id="recover-btn" class="btn btn-primary" disabled>
          <span>&#128275;</span> <span data-i18n="decrypt_btn">Unlock & Recover</span>
        </button>

        <div id="progress-bar" class="progress-bar hidden">
          <div class="fill" style="width: 0%"></div>
        </div>

        <p id="status-message" class="status-message"></p>

        <div id="files-list" class="files-list"></div>

        <div id="download-actions" class="download-actions hidden">
          <button id="download-all-btn" class="btn btn-success">
            <span>&#128229;</span> <span data-i18n="download_btn">Download archive (.tar.gz)</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>ReMemory {{VERSION}} &mdash; <span data-i18n="works_offline">Works fully offline</span></p>
    <p>
      <span data-i18n="need_help">Need help?</span>
      <a href="https://eljojo.github.io/rememory/docs#recovering" target="_blank">Docs</a> Â·
      <a href="{{GITHUB_URL}}" target="_blank" data-i18n="download_cli">Download CLI tool from GitHub</a>
    </p>
  </footer>

  <!-- Translations -->
  <script nonce="{{CSP_NONCE}}">
    const translations = {{TRANSLATIONS}};

    let currentLang = 'en';

    function t(key, ...args) {
      let text = translations[currentLang][key] || translations['en'][key] || key;
      args.forEach((arg, i) => {
        text = text.replace(`{${i}}`, arg);
      });
      return text;
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('rememory-lang', lang);

      // Update toggle buttons
      document.querySelectorAll('.lang-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Update all translatable elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        el.textContent = t(key);
      });

      // Update placeholder attributes
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        el.placeholder = t(key);
      });

      // Update page title
      document.title = t('title');
    }

    // Set initial language immediately (before app.js runs)
    (function() {
      const saved = localStorage.getItem('rememory-lang');
      const browserLang = navigator.language.split('-')[0];
      currentLang = saved || (['es', 'de', 'fr', 'sl'].includes(browserLang) ? browserLang : 'en');
    })();

    // Initialize language toggle buttons after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // If personalized with a language preference and no saved preference, use it
      if (window.PERSONALIZATION && window.PERSONALIZATION.language && !localStorage.getItem('rememory-lang')) {
        currentLang = window.PERSONALIZATION.language;
      }

      // Toggle nav links: bundle mode shows only Guide (absolute), standalone shows all (relative)
      if (window.PERSONALIZATION) {
        document.getElementById('nav-links-standalone')?.classList.add('hidden');
        document.getElementById('nav-links-bundle')?.classList.remove('hidden');
      }

      setLanguage(currentLang);

      // Add click handlers
      document.querySelectorAll('.lang-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          setLanguage(btn.dataset.lang);
          // Re-render dynamic content when language changes
          if (typeof window.rememoryUpdateUI === 'function') {
            window.rememoryUpdateUI();
          }
        });
      });
    });
  </script>

  <!-- Go WASM runtime -->
  <script nonce="{{CSP_NONCE}}">{{WASM_EXEC}}</script>

  <!-- Embedded WASM binary (base64) -->
  <script nonce="{{CSP_NONCE}}">
    window.WASM_BINARY = "{{WASM_BASE64}}";
  </script>

  <!-- Personalization data (embedded for this specific friend) -->
  <script nonce="{{CSP_NONCE}}">
    window.PERSONALIZATION = {{PERSONALIZATION_DATA}};
  </script>

  <!-- Application logic (must come after WASM_BINARY and PERSONALIZATION) -->
  <!-- App.js handles WASM loading with gzip decompression -->
  <script nonce="{{CSP_NONCE}}">{{APP_JS}}</script>
</body>
</html>
