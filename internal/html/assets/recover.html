<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ReMemory Recovery Tool</title>
  <style>{{STYLES}}</style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; color: #7f8c8d;" data-i18n="loading">Loading recovery module...</p>
  </div>

  <div class="container">
    <header>
      <div class="lang-toggle">
        <button data-lang="en" class="active">EN</button>
        <button data-lang="es">ES</button>
        <button data-lang="de">DE</button>
        <button data-lang="fr">FR</button>
      </div>
      <h1 data-i18n="title">ðŸ§  ReMemory Recovery</h1>
      <p data-i18n="subtitle">Recover your encrypted files using Shamir's Secret Sharing</p>
    </header>

    <!-- Step 1: Collect Shares -->
    <div class="card">
      <h2><span class="step-number">1</span> <span data-i18n="step1_title">Collect Shares</span></h2>
      <div id="share-drop-zone" class="drop-zone">
        <p data-i18n="step1_drop">Drag & drop README.txt files here, or click to browse</p>
        <small data-i18n="step1_hint">Each README.txt contains the share for that person</small>
      </div>
      <input type="file" id="share-file-input" accept=".txt,.zip" multiple>

      <div class="paste-section">
        <button id="paste-toggle-btn" class="btn btn-secondary" type="button">
          <span>ðŸ“‹</span> <span data-i18n="paste_btn">Paste a share</span>
        </button>
        <div id="paste-area" class="paste-area hidden">
          <textarea id="paste-input" placeholder="Paste share text here..." data-i18n-placeholder="paste_placeholder" rows="6"></textarea>
          <button id="paste-submit-btn" class="btn btn-primary" type="button" data-i18n="paste_submit">Add Share</button>
        </div>
      </div>

      <div id="shares-list" class="shares-list"></div>

      <!-- Contact list for other friends (populated via JS if personalization data exists) -->
      <div id="contact-list-section" class="contact-list-section hidden">
        <h3 data-i18n="contact_list">Contact other share holders</h3>
        <p class="hint" data-i18n="contact_list_hint">Reach out to these friends to collect their shares</p>
        <div id="contact-list" class="contact-list"></div>
      </div>

      <div id="threshold-info" class="threshold-info hidden"></div>
    </div>

    <!-- Step 2: Load Manifest -->
    <div class="card">
      <h2><span class="step-number">2</span> <span data-i18n="step2_title">Load Encrypted Manifest</span></h2>
      <div id="manifest-drop-zone" class="drop-zone">
        <p data-i18n="step2_drop">Drag & drop MANIFEST.age here, or click to browse</p>
        <small data-i18n="step2_hint">This is the encrypted file containing your secrets</small>
      </div>
      <input type="file" id="manifest-file-input" accept=".age">

      <div id="manifest-status" class="manifest-status hidden">
        <span class="icon">&#128196;</span>
        <div data-i18n="no_manifest">No manifest loaded</div>
      </div>
    </div>

    <!-- Step 3: Recover -->
    <div class="card">
      <h2><span class="step-number">3</span> <span data-i18n="step3_title">Recover Files</span></h2>
      <div id="recover-section" class="recover-section">
        <button id="recover-btn" class="btn btn-primary" disabled>
          <span>&#128275;</span> <span data-i18n="decrypt_btn">Decrypt & Recover</span>
        </button>

        <div id="progress-bar" class="progress-bar hidden">
          <div class="fill" style="width: 0%"></div>
        </div>

        <p id="status-message" class="status-message"></p>

        <div id="files-list" class="files-list"></div>

        <div id="download-actions" class="download-actions hidden">
          <button id="download-all-btn" class="btn btn-success">
            <span>&#128229;</span> <span data-i18n="download_btn">Download Archive (.tar.gz)</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>ReMemory {{VERSION}} &mdash; <span data-i18n="works_offline">Works completely offline</span></p>
    <p>
      <span data-i18n="need_help">Need help?</span>
      <a href="https://eljojo.github.io/rememory/docs.html" target="_blank">Docs</a> Â·
      <a href="{{GITHUB_URL}}" target="_blank" data-i18n="download_cli">Download CLI tool from GitHub</a>
    </p>
  </footer>

  <!-- Translations -->
  <script>
    const translations = {
      en: {
        loading: "Preparing the recovery tool...",
        title: "ðŸ§  ReMemory Recovery",
        subtitle: "A tool made for friends to unite in trying times...",
        step1_title: "Gather the pieces",
        step1_drop: "Drop the README.txt files here, or click to choose them",
        step1_hint: "Each file holds one personâ€™s piece",
        step2_title: "Add the encrypted archive",
        step2_drop: "Drop MANIFEST.age here, or click to choose it",
        step2_hint: "This is the locked archive with the memories inside",
        step3_title: "Recover the files",
        decrypt_btn: "Unlock & Recover",
        download_btn: "Download the archive (.tar.gz)",
        no_manifest: "No archive added yet",
        works_offline: "Works fully offline",
        need_help: "Need help?",
        download_cli: "Download CLI tool from GitHub",
        need_more: "Waiting for {0} more piece(s)",
        ready: "Everythingâ€™s ready",
        shares_of: "{0} of {1} pieces",
        share_index: "Piece {0} of {1}",
        remove: "Remove",
        loaded: "loaded",
        manifest_loaded_bundle: "loaded from bundle",
        combining: "Bringing the pieces together...",
        decrypting: "Unlocking the archive...",
        reading: "Opening the archive...",
        complete: "All done. {0} file(s) recovered.",
        error: "Error: {0}",
        duplicate: "That piece is already here (index {0})",
        no_share: "No piece found in {0}",
        invalid_share: "That piece looks invalid in {0}: {1}",
        paste_btn: "Paste a piece",
        paste_placeholder: "Paste the piece text here...",
        paste_submit: "Add piece",
        paste_no_share: "No piece found in the pasted text",
        your_share: "Your piece",
        your_share_loaded: "Your piece is already here",
        contact_list: "Contact the others",
        contact_list_hint: "Reach out to these friends to gather their pieces",
        shares_remaining: "{0} more piece(s) needed",
        email_label: "Email",
        phone_label: "Phone"
      },

      es: {
        loading: "Preparando la herramienta de recuperaciÃ³n...",
        title: "ðŸ§  Recordando Recuerdos",
        subtitle: "Cuando las cosas se ponen difÃ­ciles, los amigos se ayudan",
        step1_title: "Reunir las partes",
        step1_drop: "Arrastra los archivos README.txt aquÃ­, o haz clic para buscarlos",
        step1_hint: "Cada archivo contiene la parte de una persona",
        step2_title: "Agregar el archivo encriptado",
        step2_drop: "Arrastra MANIFEST.age aquÃ­, o haz clic para buscarlo",
        step2_hint: "Este es el archivo encriptado que guarda los recuerdos",
        step3_title: "Recuperar los archivos",
        decrypt_btn: "Desbloquear y recuperar",
        download_btn: "Descargar el archivo (.tar.gz)",
        no_manifest: "AÃºn no hay ningÃºn archivo cargado",
        works_offline: "Funciona completamente sin internet",
        need_help: "Â¿Necesitas ayuda?",
        download_cli: "Descarga la herramienta CLI desde GitHub",
        need_more: "Faltan {0} parte(s)",
        ready: "Todo estÃ¡ listo",
        shares_of: "{0} de {1} partes",
        share_index: "Parte {0} de {1}",
        remove: "Eliminar",
        loaded: "cargado",
        manifest_loaded_bundle: "cargado del paquete",
        combining: "Uniendo las partes...",
        decrypting: "Desbloqueando el archivo...",
        reading: "Abriendo el archivo...",
        complete: "Listo. {0} archivo(s) recuperado(s).",
        error: "Error: {0}",
        duplicate: "Esa parte ya fue agregada (Ã­ndice {0})",
        no_share: "No se encontrÃ³ ninguna parte en {0}",
        invalid_share: "La parte en {0} no es vÃ¡lida: {1}",
        paste_btn: "Pegar una parte",
        paste_placeholder: "Pega aquÃ­ el texto de la parte...",
        paste_submit: "Agregar parte",
        paste_no_share: "No se encontrÃ³ ninguna parte en el texto pegado",
        your_share: "Tu parte",
        your_share_loaded: "Tu parte ya estÃ¡ cargada",
        contact_list: "Contactar a los demÃ¡s",
        contact_list_hint: "Habla con estos amigos para reunir sus partes",
        shares_remaining: "Faltan {0} parte(s)",
        email_label: "Correo",
        phone_label: "TelÃ©fono"
      },

      de: {
        loading: "Wiederherstellung wird vorbereitet...",
        title: "ðŸ§  ReMemory Wiederherstellung",
        subtitle: "Wenn alles schwer wirkt, kann man sich auf Freunde verlassen",
        step1_title: "Teile sammeln",
        step1_drop: "README.txt-Dateien hierher ziehen oder auswÃ¤hlen",
        step1_hint: "Jede Datei enthÃ¤lt den Teil einer Person",
        step2_title: "VerschlÃ¼sseltes Archiv hinzufÃ¼gen",
        step2_drop: "MANIFEST.age hierher ziehen oder auswÃ¤hlen",
        step2_hint: "Dieses geschÃ¼tzte Archiv enthÃ¤lt die Erinnerungen",
        step3_title: "Dateien wiederherstellen",
        decrypt_btn: "Entsperren & Wiederherstellen",
        download_btn: "Archiv herunterladen (.tar.gz)",
        no_manifest: "Noch kein Archiv geladen",
        works_offline: "Funktioniert komplett offline",
        need_help: "Brauchst du Hilfe?",
        download_cli: "CLI-Tool von GitHub herunterladen",
        need_more: "Es fehlen noch {0} Teil(e)",
        ready: "Alles ist bereit",
        shares_of: "{0} von {1} Teilen",
        share_index: "Teil {0} von {1}",
        remove: "Entfernen",
        loaded: "geladen",
        manifest_loaded_bundle: "aus Bundle geladen",
        combining: "Teile werden zusammengebracht...",
        decrypting: "Archiv wird entsperrt...",
        reading: "Archiv wird geÃ¶ffnet...",
        complete: "Fertig. {0} Datei(en) wiederhergestellt.",
        error: "Fehler: {0}",
        duplicate: "Dieser Teil ist bereits vorhanden (Index {0})",
        no_share: "Kein Teil in {0} gefunden",
        invalid_share: "Der Teil in {0} ist ungÃ¼ltig: {1}",
        paste_btn: "Teil einfÃ¼gen",
        paste_placeholder: "Teil-Text hier einfÃ¼gen...",
        paste_submit: "Teil hinzufÃ¼gen",
        paste_no_share: "Kein Teil im eingefÃ¼gten Text gefunden",
        your_share: "Dein Teil",
        your_share_loaded: "Dein Teil ist bereits geladen",
        contact_list: "Die anderen kontaktieren",
        contact_list_hint: "Bitte diese Freunde um ihre Teile",
        shares_remaining: "Noch {0} Teil(e) nÃ¶tig",
        email_label: "E-Mail",
        phone_label: "Telefon"
      },

      fr: {
        loading: "PrÃ©paration de lâ€™outil de rÃ©cupÃ©ration...",
        title: "ðŸ§  RÃ©cupÃ©ration ReMemory",
        subtitle: "Quand tout devient compliquÃ©, on peut compter sur ses amis",
        step1_title: "Rassembler les parts",
        step1_drop: "DÃ©posez les fichiers README.txt ici ou sÃ©lectionnez-les",
        step1_hint: "Chaque fichier contient la part dâ€™une personne",
        step2_title: "Ajouter lâ€™archive chiffrÃ©e",
        step2_drop: "DÃ©posez MANIFEST.age ici ou sÃ©lectionnez-le",
        step2_hint: "Cette archive protÃ©gÃ©e contient les souvenirs",
        step3_title: "RÃ©cupÃ©rer les fichiers",
        decrypt_btn: "DÃ©verrouiller et rÃ©cupÃ©rer",
        download_btn: "TÃ©lÃ©charger lâ€™archive (.tar.gz)",
        no_manifest: "Aucune archive ajoutÃ©e pour le moment",
        works_offline: "Fonctionne entiÃ¨rement hors ligne",
        need_help: "Besoin d'aide ?",
        download_cli: "TÃ©lÃ©charger l'outil CLI depuis GitHub",
        need_more: "Il manque encore {0} part(s)",
        ready: "Tout est prÃªt",
        shares_of: "{0} sur {1} parts",
        share_index: "Part {0} sur {1}",
        remove: "Supprimer",
        loaded: "chargÃ©",
        manifest_loaded_bundle: "chargÃ© depuis le bundle",
        combining: "Les parts se rassemblent...",
        decrypting: "DÃ©verrouillage de lâ€™archive...",
        reading: "Ouverture de lâ€™archive...",
        complete: "Câ€™est fait. {0} fichier(s) rÃ©cupÃ©rÃ©(s).",
        error: "Erreur : {0}",
        duplicate: "Cette part est dÃ©jÃ  prÃ©sente (index {0})",
        no_share: "Aucune part trouvÃ©e dans {0}",
        invalid_share: "La part dans {0} est invalide : {1}",
        paste_btn: "Coller une part",
        paste_placeholder: "Collez le texte de la part ici...",
        paste_submit: "Ajouter la part",
        paste_no_share: "Aucune part trouvÃ©e dans le texte collÃ©",
        your_share: "Votre part",
        your_share_loaded: "Votre part est dÃ©jÃ  chargÃ©e",
        contact_list: "Contacter les autres",
        contact_list_hint: "Contactez ces amis pour rÃ©unir leurs parts",
        shares_remaining: "Il manque encore {0} part(s)",
        email_label: "E-mail",
        phone_label: "TÃ©lÃ©phone"
      }
    };

    let currentLang = 'en';

    function t(key, ...args) {
      let text = translations[currentLang][key] || translations['en'][key] || key;
      args.forEach((arg, i) => {
        text = text.replace(`{${i}}`, arg);
      });
      return text;
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('rememory-lang', lang);

      // Update toggle buttons
      document.querySelectorAll('.lang-toggle button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Update all translatable elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        el.textContent = t(key);
      });

      // Update placeholder attributes
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.dataset.i18nPlaceholder;
        el.placeholder = t(key);
      });

      // Update page title
      document.title = t('title');
    }

    // Set initial language immediately (before app.js runs)
    (function() {
      const saved = localStorage.getItem('rememory-lang');
      const browserLang = navigator.language.split('-')[0];
      currentLang = saved || (['es', 'de', 'fr'].includes(browserLang) ? browserLang : 'en');
    })();

    // Initialize language toggle buttons after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      setLanguage(currentLang);

      // Add click handlers
      document.querySelectorAll('.lang-toggle button').forEach(btn => {
        btn.addEventListener('click', () => {
          setLanguage(btn.dataset.lang);
          // Re-render dynamic content when language changes
          if (typeof window.rememoryUpdateUI === 'function') {
            window.rememoryUpdateUI();
          }
        });
      });
    });
  </script>

  <!-- Go WASM runtime -->
  <script>{{WASM_EXEC}}</script>

  <!-- Embedded WASM binary (base64) -->
  <script>
    const WASM_BINARY = "{{WASM_BASE64}}";
  </script>

  <!-- Personalization data (embedded for this specific friend) -->
  <script>
    const PERSONALIZATION = {{PERSONALIZATION_DATA}};
  </script>

  <!-- Application logic (must come after WASM_BINARY and PERSONALIZATION) -->
  <!-- App.js handles WASM loading with gzip decompression -->
  <script>{{APP_JS}}</script>
</body>
</html>
